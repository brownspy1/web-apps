{% extends 'core/base.html' %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 2rem;">

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1 style="margin-bottom: 0.5rem;">Manage Students & Data</h1>
            <p style="color: var(--text-muted);">View, Add, Edit, or Delete Students, Departments, and Semesters.</p>
        </div>
        <a href="{% url 'dashboard' %}" class="btn btn-outline">Back to Dashboard</a>
    </div>

    <!-- Tabs -->
    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color);">
        <button class="tab-btn active" onclick="openTab(event, 'Students')">Students</button>
        <button class="tab-btn" onclick="openTab(event, 'Departments')">Departments</button>
        <button class="tab-btn" onclick="openTab(event, 'Semesters')">Semesters</button>
    </div>

    <!-- Students Tab -->
    <div id="Students" class="tab-content" style="display: block;">
        <div class="card">
            <h3 style="margin-bottom: 1rem;">Filter Students</h3>
            <form method="get" class="grid-form"
                style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                <div>
                    <label>Department</label>
                    <select name="dept">
                        <option value="">All Departments</option>
                        {% for d in departments %}
                        <option value="{{ d.id }}"
                            {% if request.GET.dept == d.id|stringformat:"s" %}selected{% endif %}>{{ d.name }}
                            ({{ d.code }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label>Semester</label>
                    <select name="sem">
                        <option value="">All Semesters</option>
                        {% for s in semesters %}
                        <option value="{{ s.id }}" {% if request.GET.sem == s.id|stringformat:"s" %}selected{% endif %}>
                            {{ s.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn">Filter</button>
            </form>
        </div>

        <div class="card" style="margin-top: 2rem;">
            <form id="bulkDeleteForm" method="post" action="{% url 'student_bulk_delete' %}">
                {% csrf_token %}
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <h3>Student List ({{ students|length }})</h3>
                        <div id="selectionActions" style="display: none;">
                            <button type="submit" class="btn btn-sm"
                                style="background: #ef4444; border: none; color: white;"
                                onclick="return confirm('Are you sure you want to delete selected students?')">
                                Delete Selected (<span id="selectedCount">0</span>)
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn" onclick="openModal('studentModal')">Add Student</button>
                </div>

                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align: left; background: rgba(255,255,255,0.05);">
                                <th style="padding: 1rem; width: 40px;">
                                    <input type="checkbox" id="selectAll" onclick="toggleAll(this)">
                                </th>
                                <th style="padding: 1rem;">Roll Number</th>
                                <th style="padding: 1rem;">Department</th>
                                <th style="padding: 1rem;">Semester</th>
                                <th style="padding: 1rem; text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 1rem;">
                                    <input type="checkbox" name="student_ids" value="{{ student.id }}"
                                        class="student-checkbox" onclick="updateSelection()">
                                </td>
                                <td style="padding: 1rem; font-weight: bold;">{{ student.roll_number }}</td>
                                <td style="padding: 1rem;">{{ student.department.code }}</td>
                                <td style="padding: 1rem;">{{ student.semester.name }}</td>
                                <td style="padding: 1rem; text-align: right;">
                                    <button type="button" class="btn btn-sm btn-outline"
                                        onclick="editStudent('{{ student.id }}', '{{ student.roll_number }}', '{{ student.department.id }}', '{{ student.semester.id }}')">Edit</button>
                                    <a href="{% url 'student_delete' student.id %}" class="btn btn-sm"
                                        style="background: #ef4444; border: none; color: white;"
                                        onclick="return confirm('Delete student {{ student.roll_number }}?')">Delete</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-muted);">No
                                    students found. Add one or adjust filters.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
    </div>

    <!-- Departments Tab -->
    <div id="Departments" class="tab-content" style="display: none;">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>Departments</h3>
                <button class="btn" onclick="openModal('deptModal')">Add Department</button>
            </div>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="text-align: left; background: rgba(255,255,255,0.05);">
                        <th style="padding: 1rem;">Name</th>
                        <th style="padding: 1rem;">Code</th>
                        <th style="padding: 1rem; text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in departments %}
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 1rem;">{{ d.name }}</td>
                        <td style="padding: 1rem;">{{ d.code }}</td>
                        <td style="padding: 1rem; text-align: right;">
                            <a href="{% url 'department_delete' d.id %}" class="btn btn-sm"
                                style="background: #ef4444; border: none; color: white;"
                                onclick="return confirm('Delete {{ d.name }}? This will delete ALL associated students!')">Delete</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Semesters Tab -->
    <div id="Semesters" class="tab-content" style="display: none;">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>Semesters</h3>
                <button class="btn" onclick="openModal('semModal')">Add Semester</button>
            </div>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="text-align: left; background: rgba(255,255,255,0.05);">
                        <th style="padding: 1rem;">Name</th>
                        <th style="padding: 1rem;">Number</th>
                        <th style="padding: 1rem; text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in semesters %}
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 1rem;">{{ s.name }}</td>
                        <td style="padding: 1rem;">{{ s.number }}</td>
                        <td style="padding: 1rem; text-align: right;">
                            <a href="{% url 'semester_delete' s.id %}" class="btn btn-sm"
                                style="background: #ef4444; border: none; color: white;"
                                onclick="return confirm('Delete {{ s.name }}? This will delete ALL associated students!')">Delete</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Student Modal -->
<div id="studentModal" class="modal">
    <div class="modal-content">
        <h2>Add / Edit Student</h2>
        <form method="post" action="{% url 'student_save' %}">
            {% csrf_token %}
            <input type="hidden" name="student_id" id="modalStudentId">
            <div class="form-group">
                <label>Roll Number</label>
                <input type="text" name="roll_number" id="modalRoll" required>
            </div>
            <div class="form-group">
                <label>Department</label>
                <select name="department_id" id="modalDept" required>
                    {% for d in departments %}
                    <option value="{{ d.id }}">{{ d.name }} ({{ d.code }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Semester</label>
                <select name="semester_id" id="modalSem" required>
                    {% for s in semesters %}
                    <option value="{{ s.id }}">{{ s.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button type="submit" class="btn">Save</button>
                <button type="button" class="btn btn-outline" onclick="closeModal('studentModal')">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Dept Modal -->
<div id="deptModal" class="modal">
    <div class="modal-content">
        <h2>Add Department</h2>
        <form method="post" action="{% url 'manage_metadata' %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_department">
            <input type="hidden" name="next" value="manage_students">
            <div class="form-group">
                <label>Name</label>
                <input type="text" name="name" required placeholder="e.g. Computer Science">
            </div>
            <div class="form-group">
                <label>Code</label>
                <input type="text" name="code" required placeholder="e.g. CSE">
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button type="submit" class="btn">Save</button>
                <button type="button" class="btn btn-outline" onclick="closeModal('deptModal')">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Sem Modal -->
<div id="semModal" class="modal">
    <div class="modal-content">
        <h2>Add Semester</h2>
        <form method="post" action="{% url 'manage_metadata' %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_semester">
            <input type="hidden" name="next" value="manage_students">
            <div class="form-group">
                <label>Name</label>
                <input type="text" name="name" required placeholder="e.g. 1st Semester">
            </div>
            <div class="form-group">
                <label>Number</label>
                <input type="number" name="number" required placeholder="e.g. 1">
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button type="submit" class="btn">Save</button>
                <button type="button" class="btn btn-outline" onclick="closeModal('semModal')">Cancel</button>
            </div>
        </form>
    </div>
</div>

<style>
    .tab-btn {
        background: transparent;
        border: none;
        color: var(--text-muted);
        padding: 1rem 2rem;
        cursor: pointer;
        font-size: 1.1rem;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }

    .tab-btn:hover {
        color: white;
    }

    .tab-btn.active {
        color: var(--accent-color);
        border-bottom-color: var(--accent-color);
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        padding: 2rem;
        border-radius: 12px;
        width: 100%;
        max-width: 500px;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-muted);
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 0.75rem;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid var(--border-color);
        color: white;
        border-radius: 6px;
    }
</style>

<script>
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    function openModal(id) {
        document.getElementById(id).style.display = "flex";
    }

    function closeModal(id) {
        document.getElementById(id).style.display = "none";
        // Reset form specifics if needed
        if (id === 'studentModal') {
            document.getElementById('modalStudentId').value = '';
            document.getElementById('modalRoll').value = '';
        }
    }

    function editStudent(id, roll, dept, sem) {
        document.getElementById('modalStudentId').value = id;
        document.getElementById('modalRoll').value = roll;
        document.getElementById('modalDept').value = dept;
        document.getElementById('modalSem').value = sem;
        openModal('studentModal');
    }

    // Close modal on outside click
    window.onclick = function (event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }

    // Bulk Actions Scripts
    function toggleAll(source) {
        const checkboxes = document.querySelectorAll('.student-checkbox');
        for (let i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = source.checked;
        }
        updateSelection();
    }

    function updateSelection() {
        const checkedBoxes = document.querySelectorAll('.student-checkbox:checked');
        const count = checkedBoxes.length;
        document.getElementById('selectedCount').innerText = count;

        const actionDiv = document.getElementById('selectionActions');
        if (count > 0) {
            actionDiv.style.display = 'block';
        } else {
            actionDiv.style.display = 'none';
        }
    }
</script>
{% endblock %}