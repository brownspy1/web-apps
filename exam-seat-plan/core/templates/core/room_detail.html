{% extends 'core/base.html' %}

{% block content %}
<div class="no-print" style="margin-bottom: 2rem;">
    <div style="display: flex; gap: 1rem;">
        <a href="{% url 'dashboard' %}" class="btn btn-outline">Back to Dashboard</a>
    </div>
</div>

<div class="glass-card print-container">
    <div class="header-row"
        style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;">
        <div>
            <div class="only-print" style="text-align: center; margin-bottom: 1rem;">
                <h1>Barisal Polytechnic Institute</h1>
                <h3>Exam Seat Plan</h3>
            </div>
            <h1 style="margin-bottom: 0.5rem;" class="no-print">{{ room.name }}</h1>
            <h2 style="text-align: center; margin: 0;" class="only-print">{{ room.name }}</h2>
            <p style="color: var(--text-muted); margin: 0;" class="no-print">Exam Seat Plan Allocation</p>
            <p class="no-print" style="font-size: 0.85rem; color: var(--secondary-color); margin-top: 5px;">
                <i class="icon"></i> Click on empty seats to Disable/Enable them for allocation.
            </p>
        </div>
        <button onclick="window.print()" class="btn no-print">Download / Print PDF</button>
    </div>

    <!-- Grid View (Map) -->
    <div class="visual-grid" style="overflow-x: auto; margin-bottom: 4rem;">
        <h3 class="only-print" style="text-align: center; margin-bottom: 1rem;">Seat Map</h3>
        <div class="seat-grid"
            style="grid-template-columns: repeat({{ room.cols }}, 60px); gap: 12px; margin: 0 auto; width: fit-content;">
            {% for row in grid %}
            {% for seat in row %}
            {% if seat %}
            <button onclick="toggleSeat({{ seat.row }}, {{ seat.col }}, this)"
                class="seat {% if seat.allocation %}occupied{% elif not seat.is_active %}inactive{% endif %}"
                {% if seat.allocation %}data-dept-id="{{ seat.allocation.student.department.id }}"
                data-sem-id="{{ seat.allocation.student.semester.id }}" {% endif %}
                {% if not seat.is_active %}style="opacity: 0.2; background: #000; border-style: dashed;" {% endif %}>
                <span>
                    {% if seat.allocation %}
                    <span class="student-roll">{{ seat.allocation.student.roll_number }}</span>
                    <span class="student-class"
                        style="font-size: 0.6rem; opacity: 0.8; display: block;">{{ seat.allocation.student.department.code }}
                        - {{ seat.allocation.student.semester.number }}</span>
                    {% elif not seat.is_active %}
                    X
                    {% else %}
                    Empty
                    {% endif %}
                </span>
                <div class="seat-tooltip">Row {{ seat.row }}, Col {{ seat.col }}</div>
            </button>
            {% else %}
            <div class="seat" style="opacity: 0;"></div>
            {% endif %}
            {% endfor %}
            {% endfor %}
        </div>

        <!-- List View (Attendance Sheet) - Only Visible in Print -->
        <!-- List View (Attendance Sheet) - Removed as per request -->

        <div class="no-print"
            style="margin-top: 2rem; text-align: center; color: var(--text-muted); font-size: 0.8rem;">
            Generated by SeatPlan.AI | Total Allocated: {{ room.seats.count }}
        </div>
    </div>

    <style>
        .print-list {
            display: none;
        }

        .only-print {
            display: none;
        }

        @media print {
            @page {
                size: A4;
                margin: 20mm;
            }

            body {
                background: white;
                color: black;
                font-family: 'Times New Roman', serif;
            }

            .no-print {
                display: none !important;
            }

            .glass-card {
                box-shadow: none;
                border: none;
                background: none;
                padding: 0;
                backdrop-filter: none;
            }

            .print-list {
                display: block;
                page-break-before: always;
            }

            .visual-grid {
                page-break-inside: avoid;
            }

            .only-print {
                display: block;
            }

            .seat {
                border: 1px solid #000;
                color: #000;
                background: none !important;
            }

            .seat.occupied {
                background: #eee !important;
                font-weight: bold;
            }

            /* Typography fixes for print */
            h1,
            h2,
            h3,
            p,
            td,
            th {
                color: #000 !important;
            }

            .header-row {
                display: block !important;
                text-align: center !important;
            }

            .header-row>div {
                width: 100% !important;
            }

            .student-roll {
                color: #000 !important;
                font-weight: bold !important;
            }

            .student-class {
                color: #000 !important;
                opacity: 1 !important;
            }
        }
    </style>

    <!-- Unallocated Students Warning -->
    {% if unallocated_rolls %}
    <div id="unallocatedModal" class="no-print"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1001;">
        <div class="glass-card" style="width: 500px; padding: 2rem; max-height: 90vh; overflow-y: auto;">
            <h2 style="color: #ffcc00; margin-top: 0;">⚠️ Partial Allocation</h2>
            <p>The following students could not be allocated to this room due to lack of space or constraints:</p>

            <div
                style="background: rgba(255, 255, 255, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0; font-family: monospace; overflow-wrap: break-word;">
                Range: {{ unallocated_rolls|first }} - {{ unallocated_rolls|last }} <br>
                <span style="font-size: 0.8em; color: var(--text-muted);">Count: {{ unallocated_rolls|length }}</span>
            </div>

            {% if suggested_rooms %}
            <h3>Suggested Rooms</h3>
            <p style="font-size: 0.9em; color: var(--text-muted);">The following rooms have available seats:</p>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 1rem;">
                {% for store in suggested_rooms %}
                <div
                    style="display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px;">
                    <div>
                        <strong>{{ store.name }}</strong>
                        <div style="font-size: 0.8em; color: var(--secondary-color);">Available: {{ store.available }}
                            seats</div>
                    </div>
                    <a href="{% url 'room_detail' store.id %}" target="_blank" class="btn btn-outline"
                        style="font-size: 0.8rem;">View Room</a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="color: #ff4444;">No other rooms have available capacity!</p>
            {% endif %}

            <div style="text-align: right;">
                <button onclick="document.getElementById('unallocatedModal').style.display='none'" class="btn">Close &
                    Continue</button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Modal for Seat Management -->
    <div id="seatModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;">
        <div class="glass-card" style="width: 320px; padding: 2rem;">
            <h3 id="modalTitle">Manage Seat</h3>
            <p id="modalSeatLabel" style="margin-bottom: 1rem; color: var(--text-muted);"></p>

            <div style="margin-bottom: 1rem;">
                <label>Student Roll Number</label>
                <input type="text" id="modalRollInput" placeholder="Enter Roll to Allocate">
            </div>

            <div style="margin-bottom: 1rem;">
                <label>Department</label>
                <select id="modalDepartmentSelect"
                    style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color);">
                    <option value="">-- Select Department --</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.code }} - {{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div style="margin-bottom: 1rem;">
                <label>Semester</label>
                <select id="modalSemesterSelect"
                    style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color);">
                    <option value="">-- Select Semester --</option>
                    {% for sem in semesters %}
                    <option value="{{ sem.id }}">{{ sem.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div style="display: flex; gap: 0.5rem; justify-content: space-between;">
                    <button onclick="saveSeat()" class="btn" style="flex: 1;">Save / Allocate</button>
                    <button onclick="closeModal()" class="btn btn-outline">Cancel</button>
                </div>

                <div id="modalExtraActions"
                    style="display: flex; gap: 0.5rem; justify-content: space-between; margin-top: 10px; border-top: 1px solid #ddd; padding-top: 10px;">
                    <!-- Buttons injected by JS based on state -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentRoomId = {{ room.id }};
        let currentRow = null;
        let currentCol = null;
        let currentIsOccupied = false;
        let currentIsActive = true;

        function toggleSeat(row, col, element) {
            currentRow = row;
            currentCol = col;

            // Check state from class
            currentIsOccupied = element.classList.contains('occupied');
            currentIsActive = !element.classList.contains('inactive');

            // If Inactive -> Toggle to Active immediately (Restore)
            if (!currentIsActive) {
                apiToggleSeat();
                return;
            }

            // If Occupied OR Active(Empty) -> Open Modal
            openModal(element);
        }

        function openModal(element) {
            const rollSpan = element.querySelector('.student-roll');
            const existingRoll = rollSpan ? rollSpan.innerText : '';

            document.getElementById('modalSeatLabel').innerText = `Row ${currentRow}, Col ${currentCol}`;
            document.getElementById('modalRollInput').value = existingRoll;

            // Reset dropdowns
            document.getElementById('modalDepartmentSelect').value = '';
            document.getElementById('modalSemesterSelect').value = '';

            // If editing existing allocation, try to get dept/sem from data attributes
            // We'll need to add these as data attributes on the seat buttons
            if (currentIsOccupied && element.dataset.deptId && element.dataset.semId) {
                document.getElementById('modalDepartmentSelect').value = element.dataset.deptId;
                document.getElementById('modalSemesterSelect').value = element.dataset.semId;
            }

            const actionsDiv = document.getElementById('modalExtraActions');
            actionsDiv.innerHTML = ''; // Clear previous

            if (currentIsOccupied) {
                document.getElementById('modalTitle').innerText = "Edit Allocation";
                // Add Clear Button
                const clearBtn = document.createElement('button');
                clearBtn.className = 'btn btn-danger';
                clearBtn.innerText = 'Clear Seat';
                clearBtn.onclick = clearSeat;
                clearBtn.style.flex = "1";
                actionsDiv.appendChild(clearBtn);
            } else {
                document.getElementById('modalTitle').innerText = "Allocate Seat";
                // Add Disable Button
                const disableBtn = document.createElement('button');
                disableBtn.className = 'btn btn-outline';
                disableBtn.style.borderColor = '#ff4444';
                disableBtn.style.color = '#ff4444';
                disableBtn.innerText = 'Disable (Remove Seat)';
                disableBtn.onclick = function () { apiToggleSeat(); closeModal(); };
                disableBtn.style.flex = "1";
                actionsDiv.appendChild(disableBtn);
            }

            document.getElementById('seatModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('seatModal').style.display = 'none';
            currentRow = null;
            currentCol = null;
        }

        function saveSeat() {
            const roll = document.getElementById('modalRollInput').value;
            const deptId = document.getElementById('modalDepartmentSelect').value;
            const semId = document.getElementById('modalSemesterSelect').value;

            if (!roll) {
                alert('Please enter a roll number');
                return;
            }
            if (!deptId || !semId) {
                alert('Please select both Department and Semester');
                return;
            }

            updateSeat('update', roll, deptId, semId);
        }

        function clearSeat() {
            if (confirm('Are you sure you want to remove this allocation?')) {
                updateSeat('delete', null, null, null);
            }
        }

        function apiToggleSeat() {
            fetch(`/room/${currentRoomId}/toggle/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ row: currentRow, col: currentCol })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') location.reload();
                    else alert(data.message);
                });
        }

        function updateSeat(action, roll, deptId, semId) {
            fetch(`/room/${currentRoomId}/manage/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    row: currentRow,
                    col: currentCol,
                    action: action,
                    roll_number: roll,
                    department_id: deptId,
                    semester_id: semId
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
    {% endblock %}